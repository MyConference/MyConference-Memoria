\chapter{API y Base de Datos}
\label{chap:api}

La API (Application Programing Interface) es un servicio HTTP que regula el acceso a todos los datos de MyConference. Es el único punto de toda la infraestructura que tiene acceso a la base de datos y es la única parte que no tiene una utilidad directa para el usuario.

El resto de aplicaciones de MyConference (Web, Android) son interfaces de usuario que realizan \textit{llamadas} (peticiones HTTP) a la API, identificándose a sí mismas como aplicaciones de la plataforma e identificando al usuario a través de sus credenciales (e-mail, contraseña).

\section{Uso}

\subsection{Acceso}

El acceso a los datos, así como su modificación, se realiza mediante peticiones HTTP.

Todos los datos se envían y reciben en formato JSON. Cualquier otro formato pedido (mediante la cabecera \texttt{Accept}) o enviado (mediante \texttt{Content-Type}) será rechazado por el servidor. Esto simplifica el código de la API, puesto que JSON es un formato de representación nativo de JavaScript, el lenguaje en el que está implementada.

Para acceder a los datos es necesario disponer de un testigo de acceso, cuya obtención veremos más adelante en la sección \ref{sec:api-auth}. Para enviar este testigo usaremos la cabecera HTTP \texttt{Authorization}, con el valor \texttt{Token~\textit{token-string}} (donde \textit{token-string} es el valor del testigo del que disponemos).

Los datos de la aplicación están divididos en \textit{entidades}, que representan colecciones de datos similares. Para cada entidad disponemos, en general, de las siguientes acciones:

\begin{itemize}
  \item Ver en detalle un elemento, mediante una petición \texttt{GET /entidad/id}. Se obtiene una lista con los atributos del elemento y los elementos relacionados.
  \item Crear un nuevo elemento de un tipo, mediante una petición \texttt{POST /entidad}. Se deben enviar los atributos iniciales del elemento.
  %\item Modificar un elemento existente, mediante una petición \texttt{PUT /entidad/id}. Se deben enviar los nuevos atributos del objeto.
  \item Eliminar un elemento existente, mediante una petición \texttt{DELETE /entidad/id}. Se obtiene una confirmación.
\end{itemize}

Las entidades pueden proporcionar otras acciones en determinadas circunstancias, como se describe en el apartado \nameref{sect:api-docs}.

De la misma manera, todas las peticiones utilizan los códigos HTTP estándar, entre ellos:

\begin{itemize}
  \item \texttt{401~Unauthorized} para errores de autenticación.
  \item \texttt{403~Forbidden} para operaciones para las que el usuario no tiene permiso.
  \item \texttt{404~Not~Found} para elementos no existentes.
  \item \texttt{500~Internal~Server~Error} para problemas internos de la API.
\end{itemize}


\subsection{Autenticación}
\label{sec:api-auth}

El sistema de autenticación funciona siguiendo un esquema similar al de los estándares OAuth y OpenID.

Todos los servicios que ofrece la API de MyConference están protegidos. Para acceder a ellos es necesario obtener un \textit{testigo de acceso}, que irá unido a un usuario y se enviará en cada petición en una cabecera HTTP.

Para obtener un testigo de acceso se debe realizar una petición a una ruta específica (\texttt{/auth}) de la API, indicando lo siguiente:

\begin{itemize}
  \item Qué aplicación se está usando para realizar la petición (Identificada mediante un UUID).
  \item Qué dispositivo está realizando la petición (Cadena de texto arbitraria, permite diferenciar diferentes sesiones del mismo usuario mediante la misma aplicación).
  \item Las credenciales de acceso a la aplicación.
\end{itemize}

Existen múltiples tipos de credenciales de acceso, detallados más adelante. Si todos los datos son correctos, ocurrirá lo siguiente:

\begin{itemize}
  \item Se crea un nuevo testigo de acceso asociado al usuario cuyas credenciales coinciden.
  \item Se crea un nuevo testigo de actualización asociado al nuevo testigo de acceso.
  \item Se invalidan todos los testigos de acceso y de actualización anteriores que fueran generados usando la misma aplicación y el mismo dispositivo.
  \item Se devuelven ambos testigos, sus fechas de caducidad y el identificador del usuario identificado.
\end{itemize}

El \textit{testigo de actualización} devuelto tiene como función generar un nuevo testigo de acceso en caso de que este caduque. Los testigos de acceso tienen un tiempo de uso de unos pocos días, mientras que los testigos de actualización duran semanas. Esto minimiza la posibilidad de uso de un testigo de acceso interceptado por una tercera parte.

Para que un intento de autenticación tenga éxito, las credenciales usadas deben coincidir con algunas credenciales almacenadas en la base de datos. Los siguientes son los tipos de credenciales que se definen:

\begin{itemize}
  \item \textbf{Usuario y contraseña}: Utilizamos un nombre de usuario (correo electrónico) y contraseña registrados previamente para realizar la autenticación.
  \item \textbf{Testigo de Actualización}: Se utiliza un testigo de actualización para realizar la autenticación. La aplicación y el dispositivo con los que se generó el testigo usado deben coincidir con los datos de la petición.
  \item \textbf{Testigo de Autorización}: Se utiliza un testigo de autorización obtenido mediante otros medios para realizar la autenticación. La aplicación y el dispositivo con los que se generó el testigo usado deben coincidir con los datos de la petición.
\end{itemize}

Los testigos de autorización existen para realizar accesos mediante servicios externos, actualmente no implementados. 

% =========================================================================== %

\subsection{Servicios Disponibles}
\label{sect:api-docs}

A continuación se describen todos los servicios de la API disponibles, con el siguiente formato:

\paragraph{\texttt{VERBO /ruta/al/servicio}} ~\\

En caso de hacer falta algún parámetro en la URL, se mostrará rodeado con corchetes angulares, \texttt{<así>}.
Si hacen falta parámetros en el cuerpo (en formato JSON), se especificarán en forma de lista:

\begin{itemize}
  \item \texttt{argumento}: Descripción del argumento 
\end{itemize}

Salvo que se indique lo contrario, todas las llamadas requieren del envío de un testigo de acceso válido.

Se mostrará a su vez una descripción del servicio, así como de los posibles errores que se pudieran dar en cada uno.

% =========================================================================== %

\newpage
\subsubsection{Autentificación y Registro}

% =========================================================================== %

\paragraph{Registro (\texttt{POST /auth/signup})}

\begin{itemize}
  \item \texttt{application\_id}: ID de aplicación desde la que se realiza la petición.
  \item \texttt{device\_id}: ID del dispositivo desde el que se realiza la petición. 
  \item \texttt{user\_data}: Un objeto JSON con los campos:
  \begin{itemize}
    \item \texttt{email}: Correo electrónico del usuario a registrar.
    \item \texttt{password}: Contraseña del usuario a registrar.
  \end{itemize}
\end{itemize}

\begin{figure}[h]
  \begin{center}
    \includegraphics[width=.8\textwidth]{Imagenes/Bitmap/API/SeqDiagRegister}
    \caption{Diagrama del Proceso de Registro}
  \end{center}
\end{figure}

El registro no necesita testigo de acceso, puesto que es un proceso previo a la obtención de éste.
Los datos de usuario provistos en el cuerpo de la petición se integrarán en el sistema y se creará un nuevo usuario que podrá posteriormente identificarse con ellos.

El correo electrónico ha de ser válido y la contraseña ha de tener al menos 8 caracteres.
No existen más restricciones en la contraseña, ni en contenido ni en longitud.

% =========================================================================== %

\newpage
\paragraph{Autentificación (\texttt{POST /auth})}

\begin{itemize}
  \item \texttt{application\_id}: ID de aplicación desde la que se realiza la petición.
  \item \texttt{device\_id}: ID del dispositivo desde el que se realiza la petición. 
  \item \texttt{credentials}: Un objeto JSON con los campos:
  \begin{itemize}
    \item \texttt{type}: Tipo de credenciales a utilizar.
    El resto de campos en este objeto dependerán exclusivamente del tipo de credenciales que se estén usando.
    Este campo admite credenciales de tipo \texttt{password} y \texttt{refresh}.

    \item \texttt{email}: (si \texttt{type} es \texttt{password}) E-mail del usuario a identificar.
    \item \texttt{password}: (si \texttt{type} es \texttt{password}) Contraseña del usuario a identificar.

    \item \texttt{refresh\_token}: (si \texttt{type} es \texttt{refresh}) Testigo de actualización de un usuario ya identificado previamente.
    
  \end{itemize}
\end{itemize}

\begin{figure}[h]
  \begin{center}
    \includegraphics[width=.8\textwidth]{Imagenes/Bitmap/API/SeqDiagAuth}
    \caption{Diagrama del Proceso de Autentificación}
  \end{center}
\end{figure}

Esta llamada no necesita testigo de acceso, puesto que es precisamente con ella como podemos conseguir uno.

El campo \texttt{device\_id} es libre y puede contener cualquier cosa, pero está presente para posibilitar que un mismo usuario abra múltiples sesiones en la misma aplicación, por ejemplo, en varios PCs o dispositivos Android. Este valor debería ser tan único como fuera posible, por lo que, aunque no es un requisito, se recomienda usar un UUID o algún esquema similar. Además, si estamos realizando una llamada con credenciales de tipo \texttt{refresh}, este campo ha de coincidir con el de la llamada que generó dicho testigo de actualización originalmente.

El resultado de una llamada válida a este servicio será un objeto JSON con los siguientes campos:

\begin{itemize}
  \item \texttt{access\_token}: Nuevo token de acceso para la aplicación.
  \item \texttt{access\_expires}: Fecha de caducidad del testigo de acceso (en formato ISO).
  \item \texttt{refresh\_token}: Nuevo token de actualización para la aplicación.
  \item \texttt{refresh\_expires}: Fecha de caducidad del testigo de actualización (en formato ISO).
  \item \texttt{user}: Información del usuario con el que acabamos de iniciar sesión, como los campos:
  \begin{itemize}
    \item \texttt{id}: Identificador del usuario.
    \item \texttt{url}: Ruta completa a la que realizar una llamada para obtener toda la información del usuario.
  \end{itemize}
\end{itemize}

% =========================================================================== %

\paragraph{Desautorización (\texttt{POST /auth/logout})} ~\\

Este servicio no necesita datos extra. Tras realizar esta llamada, el testigo de acceso y su testigo de actualización asociado serán deshabilitados, desautorizando al usuario de todo acceso con dichos testigos.

Este servicio está pensado para utilizarse por las aplicaciones para implementar el ``cierre de sesión'' característico de cualquier aplicación o servicio web de una forma segura que no engañe al usuario, que realmente desautorice el acceso en lugar de simplemente olvidarlo y dejarlo caducar.

% =========================================================================== %

\subsubsection{Usuarios y Congresos}

\paragraph{Datos de usuario (\texttt{GET /users/<user-id>})} ~\\

Devolverá la información del usuario indicado en \texttt{user-id} como un objeto JSON con los siguientes campos:

\begin{itemize}
  \item \texttt{id}: Identificador del usuario.
  \item \texttt{url}: Ruta completa del usuario en la API.
  \item \texttt{conferences}: Un array JSON con objetos JSON con los siguientes campos.
  \begin{itemize}
    \item \texttt{id}: Identificador del congreso.
    \item \texttt{url}: Ruta completa del congreso en la API.
    \item \texttt{role}: Rol del usuario en el congreso (\texttt{owner}, \texttt{assistant})
  \end{itemize}
\end{itemize}

% =========================================================================== %

\paragraph{Congresos del usuario (\texttt{GET /users/<user-id>/conferences})} ~\\

Devolverá la lista de congresos del usuario indicado en \texttt{user-id} como una lista de objetos JSON con los siguientes campos:

\begin{itemize}
  \item \texttt{id}: Identificador del congreso.
  \item \texttt{url}: Ruta completa del congreso en la API.
  \item \texttt{name}: Nombre del congreso.
  \item \texttt{description}: Descripción completa del congreso.
  \item \texttt{role}: Rol del usuario en el congreso (\texttt{owner}, \texttt{assistant})
\end{itemize}

% =========================================================================== %

\paragraph{Información de Congreso (\texttt{GET /conferences/<conference-id>})} ~\\

Devolverá la información del congreso indicado en \texttt{conference-id} como un objeto JSON con los siguientes campos:

\begin{itemize}
  \item \texttt{id}: Identificador del congreso.
  \item \texttt{url}: Ruta completa del congreso en la API.
  \item \texttt{name}: Nombre del congreso.
  \item \texttt{description}: Descripción completa del congreso.
  \item \texttt{documents}: Array JSON con los documentos (enlaces) del congreso.
  \item \texttt{venues}: Array JSON con los lugares del congreso.
  \item \texttt{announcements}: Array JSON con los anuncios del congreso.
  \item \texttt{organizers}: Array JSON con los organizadores del congreso.
  \item \texttt{speakers}: Array JSON con los ponentes del congreso.
  \item \texttt{agendaEvents}: Array JSON con los eventos del programa del congreso.
  \item \texttt{usuarios}: Array JSON con los usuarios asistentes al congreso.
\end{itemize}

El contenido exacto de los objetos de cada uno de los arrays se especificará más adelante.

% =========================================================================== %

\paragraph{Creación de Congresos (\texttt{POST /conferences})} ~\\

\begin{itemize}
  \item \texttt{name}: Nombre del congreso.
  \item \texttt{description}: Descripción completa del congreso.
\end{itemize}

Crea un nuevo congreso y añade al usuario identificado como único propietario del mismo.

% =========================================================================== %

\paragraph{Creación de Congresos (\texttt{DELETE /conferences/<conference-id>})} ~\\

Elimina completamente el congreso indicado en \texttt{conference-id} y todos los datos relacionados con él, de forma irreversible.

Para que esta llamada tenga efecto, el usuario debe der propietario del congreso.

% =========================================================================== %

\newpage
\section{Implementación}

\textit{Sección sin completar}

\subsection{Base de Datos}

La base de datos (MongoDB) está estructurada en torno a la entidad \textit{Congreso} (\texttt{Conference}). Esta es la entidad fundamental del sistema, y la única junto con los usuarios y exceptuando otras entidades auxiliares que no depende de ninguna otra entidad, es decir, que puede existir por su propio pie.

\subsubsection{Entidades Fundamentales}

%\textit{Futuro gráfico entidad-relación con toda la "jerarquía" de entidades}

\subsubsection{Entidades de Apoyo}

%\textit{Futuro gráfico entidad-relación con las entidades de apoyo (tokens, loginmethods)}

Existen otras entidades en la base de datos que aportan funcionalidad pero no representan datos de negocio.

La entidad \texttt{LoginMethod} representa un método de acceso a la aplicación. Actualmente sólo contiene métodos de tipo \texttt{password}, utilizados para el acceso mediante e-mail y contraseña. Los accesos mediante servicios externos (Google, Facebook, Twitter) se incluirían en esta colección, utilizando distintos tipos 

