\section{API}
\label{sec:deploy-api}

La API, descrita en el capítulo \ref{chap:webservice}, es la columna vertebral de MyConference, y por tanto será la primera parte del sistema que se instalará y configurará.

En primer lugar es necesario tener instalado \nameref{tech:nodejs}, versión \texttt{0.12} o superior.
A continuación debemos, usando un terminal y desde la carpeta raíz del proyecto, ejecutar:

\begin{lstlisting}[language=bash]
  $ npm install
\end{lstlisting}

Esto descargará e instalará las dependencias necesarias para ejecutar la API en sutotalidad.
Para hacerlo, ejecutaremos:

\begin{lstlisting}[language=bash]
  $ npm start
\end{lstlisting}

Sin embargo, en este punto probablemente veamos algún error en la consola, debido a que la aplicación no ha sido configurada en absoluto.
Para su configuración local se utilizará \nameref{tech:foreman} (Véase \ref{tech:foreman}), mientras que para el despliegue final utilizaremos Heroku.

\subsection{Configuración con Foreman}
\label{sec:deploy-foreman}

En primer lugar deberemos descargar e instalar \texttt{foreman}.
Dependiendo de la plataforma el proceso puede variar, por lo que no entraremos en detalles.

Tras la instalación, se necesitan dos ficheros: \texttt{Procfile} y \texttt{.env}.
El fichero \texttt{Procfile} define los prcesos que se ejecutarán con la aplicación, y ya está creado.
El fichero \texttt{.env} contiene las variables de configuración en forma de variables de entorno con la siguiente sintaxis:

\begin{lstlisting}[language=bash]
  VAR1=valor 1
  VAR2=valor 2
\end{lstlisting}

Este fichero \textbf{nunca} debe añadirse a ningún sistema de control de versiones, y será diferente en cada máquina (desarrollo, pruebas, producción).

Una vez definidos estosdos ficheros, lanzaremos la aplicación usando el comando

\begin{lstlisting}[language=bash]
  $ foreman start
\end{lstlisting}

Por defecto, Foreman establece la variable de etorno \texttt{PORT} a 5000, e iráincrementando este valor si lanzamosvariosprocesos. Para cambiar el valor inicial de esta variable, podemos utilizar la opción \texttt{-p}. Si queremos que se utilice el puerto 80 para obtener conectividad HTTP directa, deberemos lanzar el servidor con privilegios de superusuario:

\begin{lstlisting}[language=bash]
  # foreman start -p 80
\end{lstlisting}

\subsection{Configuración de MongoDB}

Para que la API funcione correctamente, necesita conectividad con una base de datos MongoDB.

Para configurar qué base de datos utilizar, se deben establecer la variable \texttt{MONGO\_URI} a una URI de tipo \texttt{mongodb:}, como por ejemplo \texttt{mongodb://root:root@example.org/myconference}.
También se aceptará este valor si se utiliza la variable \texttt{MONGOLAB\_URI}, como se explicará en el punto \ref{sec:deploy-api-heroku}.

La base de datos en sí no necesita más configuración. Una vez la API sepa qué host, usuario y contraseña debe utilizar, la base de datos está completamente configurada.


\subsection{Configuración de Mandrill}
\label{sec:api-conf-mandrill}

Para permitir el envío de correos electrónicos, MyConference utiliza Mandrill, un servicio de envío de correo electrónico en la nube.

Para configurar la cuenta de usuario de Mandrill que se utilizará, se deben establecer las variables \texttt{MANDRILL\_USERNAME} y \texttt{MANDRILL\_APIKEY} con el nobre de usuario y la API-key de Mandrill respectivamente.

Una vez la API tiene acceso a la cuenta de Mandrill, es necesario crear una plantilla en el panel de control de Mandrill llamada \texttt{invitation-code}, que contendrá el correo enviado a los usuarios cuando se les invite a un congreso de MyConference. Esta plantilla utiliza las siguientes \textit{merge variables}:

\begin{itemize}
  \item \texttt{CONFNAME}: El nombre completo del congreso.
  \item \texttt{JOINURL}: La URL de la página en la que el usuario puede unirse a un congreso
  \item \texttt{JOINCODE}: El código que el usuario debe introducir en dicha URL
\end{itemize}

Nótese que mediante \texttt{*|JOINURL|*?code=*|JOINCODE|*} podemos obtener la URL completa de la página en la que el usuario se unirá a la conferencia, con el código ya introducido para que el usuario simplemente acepte.

A continuación se muestra un código básico que se puede usar en esta plantilla.

\begin{lstlisting}[language=html,frame=single]
<h1>You have been invited to join *|CONFNAME|* on MyConference</h1>
<p>
  <a href="*|JOINURL|*?code=*|JOINCODE|*">Click Here</a>
  to join or enter the code *|JOINCODE|* in the
  <a href="*|JOINURL|*">Join Conference</a>
  view on the MyConference Web or Mobile App.
</p>
\end{lstlisting}


\subsection{Configuración General}
\label{sec:api-conf-general}

Además de la configuración anterior, existen otras variables que debemos configurar para que la API funcione correctamente:

\begin{itemize}
  \item \texttt{HOST}: El nombre de dominio (host) completo de la API, por ejemplo \texttt{api.myconference.com}. Nótese que no deben aparecer separadores de ruta (\texttt{/}) ni prefijos de esquema (\texttt{http://}).
  \item \texttt{NODE\_ENV}: Debe contener \texttt{production} en entornos de producción y \texttt{development} en desarrollo.
  \item \texttt{WEB\_URL}: Debe contener la URL completa a la aplicación web de MyConference, por ejemplo \texttt{http://myconference.com}. Nótese que no debe aparecer el separador final de ruta (\texttt{/}) pero sí el prefijo de esquema (\texttt{http://}).
\end{itemize}

Tras realizar toda la configuración, hay que realizar un paso más: Crear las entradas de las aplicaciones por defecto. Los siguientes comandos, ejecutados en orden, nos mostrarán los IDs de dichas aplicaciones, que se habrán creado si no existían:

\begin{lstlisting}[language=bash]
  $ cat .env | eval
  $ export MONGO_URI MONGOLAB_URI
  $ node scripts/get_or_create_apps.js
  $ unset MONGO_URI MONGOLAB_URI
\end{lstlisting}

Debemos apuntar estos datos puesto que serán necesarios para configurar las aplicaciones Web, Android e iOS

Con esto, la API está lista para funcionar.


\subsection{Heroku}
\label{sec:deploy-api-heroku}

El desarrollo original de MyConference ha sido probado y puesto en marcha en Heroku (Véase \ref{tech:heroku}) desde el primer día, y todo el sistema de configuración se integra a la perfección con Heroku.

Para desplegar la API en Heroku, el primer paso es registrarse y crear una aplicación. Tras esto pasamos a configurar algunos add-ons necesarios:

\begin{description}
  \item[MongoLab] es el proveedor de MongoDB elegido.

  Puesto que MongoLab no requiere ninguna configuración, bastará con añadir a la aplicación una instancia \textit{Sandbox} gratuita.

  Se ha de tener en cuenta que el código actualmente está preparado para leer la variable de configuración \texttt{MONGOLAB\_URI} que establece MongoLab automáticamente, por lo que si se utilizara otro servicio habría que modificar dicho código o establecer la variable \texttt{MONGO\_URI} manualmente.

  \item[Mandrill by MailChimp] es el servicio elegido para el envío de correo electrónico.

  Debemos añadir a la aplicación una instancia (puede ser \textit{Starter}, gratuita) de Mandrill. Al hacerlo se añadirán a la aplicación las variables \texttt{MANDRILL\_USERNAME} y \texttt{MANDRILL\_APIKEY}.

  Para que este add-on se integre correctamente, se debe realizar la configuración de Mandrill tal como se describe en el punto \ref{sec:api-conf-mandrill}.

\end{description}

A continuación faltará realizar la configuración descrita en el punto \ref{sec:api-conf-general}.

Heroku tiene su propia forma de realizar la configuración en lugar de utilizar un fichero \texttt{.env}.
En primer lugar debemos instalar la utilidad de Heroku para línea de comandos, tal como se explica en \url{https://devcenter.heroku.com/articles/heroku-command}. Una vez hecho esto, procederemos a realizar la configuración.

Para establecer variables de configuración utilizaremos el siguiente comando:

\begin{lstlisting}[language=bash]
  $ heroku config:set VAR1="valor 1" VAR2="valor 2"
\end{lstlisting}

En este caso, debemos ejecutar un comando similar a este:

\begin{lstlisting}[language=bash]
  $ heroku config:set \
        NODE_ENV=production \
        HOST=api.myconference.com \
        WEB_URL=http://myconference.com
\end{lstlisting}

Una vez tenemos la configuración y los add-ons, es hora de desplegar la aplicación. Para ello, usando \nameref{tech:git}, desde la raíz de nuestro proyecto, ejecutaremos:

\begin{lstlisting}[language=bash]
  $ git push heroku master
\end{lstlisting}

Debemos haber configurado el código para utilizar \texttt{git}, y haber apuntado el \textit{remote} \texttt{heroku} a la URL de nuestra aplicación en Heroku (\texttt{git@heroku.com:myconference-api.git}, por ejemplo).

Una vez termine el despliegue de la aplicación, falta configurar los datos iniciales de la aplicación, mediante el siguiente comando:

\begin{lstlisting}[language=bash]
  $ heroku run 'node scripts/get_or_create_apps.js'
\end{lstlisting}

De nuevo obtendremos datos que debemos apuntar, puesto que serán necasios para el resto de aplicaciones.