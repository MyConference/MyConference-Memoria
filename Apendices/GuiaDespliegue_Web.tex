\section{Web}

La web de MyConference, descrita en el capítulo \ref{chap:web}, es la única aplicación que permite la introducción de datos en el sistema, más allá de la creación de nuevos usuarios.

Su despliegue es muy similar al de la API, descrito en el punto \ref{sec:deploy-api}, puesto que utilizan las mismas tecnologías básicas.

De igual manera que en la API, lo primero que hemos de hacer es instalar las dependencias, ejecutando el siguiente comando:

\begin{lstlisting}[language=bash]
  $ npm install
\end{lstlisting}

Tras esto pasaremos a la configuración con Foreman y, posteriormente, Heroku.

Para una breve introducción al uso de Foreman, véase la sección \ref{sec:deploy-foreman} \nameref{sec:deploy-foreman}.


\subsection{Configuración de MongoDB}

Para que la web funcione correctamente, necesita conectividad con una base de datos MongoDB.
A diferencia de la base de datos de la API, esta base de datos se utiliza úncamente para persistir información de la sesión de usuario, nunca para almacenar datos de MyConference.

Para configurar qué base de datos utilizar, se deben establecer la variable \texttt{MONGO\_URI} a una URI de tipo \texttt{mongodb:}, como por ejemplo \texttt{mongodb://root:root@example.org/myconference}.
También se aceptará este valor si se utiliza la variable \texttt{MONGOLAB\_URI}, como se explicará en el punto \ref{sec:deploy-web-heroku}.

La base de datos en sí no necesita más configuración. Una vez la web sepa qué host, usuario y contraseña debe utilizar, la base de datos está completamente configurada.


\subsection{Configuración de Transloadit}

Para que el sistema de subida de archivos funcione correctamente, la web necesita conectividad con una cuenta de Transloadit (Véase \ref{tech:transloadit}).

Transloadit utiliza las siguientes variables de configuración:

\begin{itemize}
  \item \texttt{TRANSLOADIT\_AUTH\_KEY}: Clave de autorización de la cuenta de Transloadit.
  \item \texttt{TRANSLOADIT\_SECRET\_KEY}: Clave secreta de la cuenta de Transloadit.
  \item \texttt{TRANSLOADIT\_URL}: URL de la API de Transloadit (\url{https://api2.transloadit.com}).
  \item \texttt{TRANSLOADIT\_TEMPLATE\_SPEAKERS}: Identificador de la plantilla usada para la carga de imágenes de \textit{keynote speakers}, creada más adelante.
\end{itemize}

Una vez establecidas las variables, debemos configurar Transloadit.
Para ello necesitamos crear la plantilla que usaremos para la carga de imágenes.
Simplemente crearemos una nueva plantilla e introduciremos lo siguiente:

\begin{lstlisting}[frame=single]
{
  "steps": {
    "resize_xxhdpi": {
      "robot": "/image/resize",
      "use": ":original",
      "width": 240,
      "height": 300
    },
    "export": {
      "robot": "/ftp/store",
      "use": "resize_xxhdpi",
      "host": "ftp.example.org",
      "user": "myconference-user",
      "password": "myconference-password",
      "path": "/${file.id}.${file.ext}",
      "url_template":
        "http://example.org/path/to/${file.id}.${file.ext}"
    }
  }
}
\end{lstlisting}

Los datos han de ser ajustados para utilizar una cuenta de FTP existente, así como para que la URL permita una descarga directa de la imagen.

Una vez tengamos la platilla creada, añadiremos el ID generado a la variable de configuración \texttt{TRANSLOADIT\_TEMPLATE\_SPEAKERS}.


\subsection{Configuración General}
\label{sec:web-conf-transloadit}

Además de la configuración anterior, existen otras variables que debemos configurar para que la web funcione correctamente:

\begin{itemize}
  \item \texttt{NODE\_ENV}: Debe contener \texttt{production} en entornos de producción y \texttt{development} en desarrollo.
  \item \texttt{API\_URL}: Debe contener la URL completa a la API de MyConference, por ejemplo \texttt{http://api.myconference.com}. Nótese que no debe aparecer el separador final de ruta (\texttt{/}) pero sí el prefijo de esquema (\texttt{http://}).
  \item \texttt{APPLICATION}: Debe contener el ID de aplicación asociado a la web, obtenido previamente al configurar la API en el paso de creación de aplicaciones.
\end{itemize}

Con esto, la web está completamente lista para funcionar.



\subsection{Heroku}
\label{sec:deploy-web-heroku}

El desarrollo original de MyConference ha sido probado y puesto en marcha en Heroku (Véase \ref{tech:heroku}) desde el primer día, y todo el sistema de configuración se integra a la perfección con Heroku.

Para desplegar la web en Heroku, el primer paso es registrarse y crear una aplicación. Tras esto pasamos a configurar algunos add-ons necesarios:

\begin{description}
  \item[MongoLab] es el proveedor de MongoDB elegido.

  Puesto que MongoLab no requiere ninguna configuración, bastará con añadir a la aplicación una instancia \textit{Sandbox} gratuita.

  Se ha de tener en cuenta que el código actualmente está preparado para leer la variable de configuración \texttt{MONGOLAB\_URI} que establece MongoLab automáticamente, por lo que si se utilizara otro servicio habría que modificar dicho código o establecer la variable \texttt{MONGO\_URI} manualmente.

  \item[Transloadit] es el servicio elegido para la gestión de subidas de imágenes.

  Debemos añadir a la aplicación una instancia de Transloadit. Al hacerlo se añadirán a la aplicación las variables \texttt{TRANSLOADIT\_AUTH\_KEY}, \texttt{TRANSLOADIT\_SECRET\_KEY} y \texttt{TRANSLOADIT\_URL}.

  Para que este add-on se integre correctamente, se debe realizar la configuración de Transloadit tal como se describe en el punto \ref{sec:web-conf-transloadit}, incluyendo la variable de configuración \texttt{TRANSLOADIT\_TEMPLATE\_SPEAKERS}.

\end{description}

A continuación faltará realizar la configuración descrita en el punto \ref{sec:web-conf-general}.

Para ello utilizaremos la herramienta de línea de comandos de Heroku, descrita en el punto \ref{sec:api-conf-heroku}.

En este caso, debemos ejecutar un comando similar a este:

\begin{lstlisting}[language=bash]
  $ heroku config:set NODE_ENV=production APPLICATION=webapplicationid API_URL=http://api.myconference.com
\end{lstlisting}

Una vez tenemos la configuración y los add-ons, es hora de desplegar la aplicación. Para ello, usando \nameref{tech:git}, desde la raíz de nuestro proyecto, ejecutaremos:

\begin{lstlisting}[language=bash]
  $ git push heroku master
\end{lstlisting}

Debemos haber configurado el código para utilizar \texttt{git}, y haber apuntado el \textit{remote} \texttt{heroku} a la URL de nuestra aplicación en Heroku (\texttt{git@heroku.com:myconference-web.git}, por ejemplo).
